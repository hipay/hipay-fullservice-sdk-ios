machine:
  xcode:
    version: "8.0"
  environment:
    GYM_CODE_SIGNING_IDENTITY: "iPhone Distribution: HiPay Group (7RLJNKW437)"
    GYM_PROVISIONING_PROFILE_PATH: "deployment/distribution.mobileprovision" 
    GYM_SCHEME: "HiPayFullservice-Example"
    GYM_WORKSPACE: "Example/HiPayFullservice.xcworkspace"
    XCODE_SCHEME: "HiPayFullservice-Example"
    LANG: en_US.UTF-8

dependencies:
  pre:
    - cd Example; pod install
    - brew uninstall xctool && brew install --HEAD xctool

test:
  override:
    - set -o pipefail &&
      xcodebuild
        CODE_SIGNING_REQUIRED=NO
        CODE_SIGN_IDENTITY=
        PROVISIONING_PROFILE=
        -sdk iphonesimulator
        -destination 'id=DFB14113-4697-4E2D-AD3F-B4FBA4B62969'
        -workspace Example/HiPayFullservice.xcworkspace
        -scheme "HiPayFullservice-Example"
        clean build test |
      tee $CIRCLE_ARTIFACTS/xcode_raw.log |
      xcpretty --color --report junit --output $CIRCLE_TEST_REPORTS/xcode/results.xml

deployment:
  distribution:
    branch: "/.*/"
    commands:
       - python deployment/get_identifier.py > $CIRCLE_ARTIFACTS/app_identifier
       - rm Example/HiPayFullservice/Resources/Parameters/parameters.plist
       - (cd deployment/; python set_build_number.py)
       - (export HOCKEY_APP_IDENTIFIER=$(cat $CIRCLE_ARTIFACTS/app_identifier); cd deployment/; python generate_parameters.py)
       - gym
       - ipa distribute:hockeyapp 
           --token            "$HOCKEY_APP_TOKEN"
           --notes            "CircleCI build $CIRCLE_BUILD_NUM"
           --commit-sha       "$CIRCLE_SHA1"
           --build-server-url "$CIRCLE_BUILD_URL"
           --repository-url   "$CIRCLE_REPOSITORY_URL" 
           --identifier       "$(cat $CIRCLE_ARTIFACTS/app_identifier)"
